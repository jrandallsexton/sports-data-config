apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-values
  namespace: monitoring
data:
  values.yaml: |
    grafana:
      enabled: true
      adminPassword: "admin" # dev only; replace later
      service:
        type: ClusterIP
      envFromSecret: ""
      grafana.ini:
        server:
          domain: 192.168.0.112:8080
          root_url: http://192.168.0.112:8080/grafana/
          serve_from_sub_path: true
      sidecar:
        datasources:
          enabled: true
          defaultDatasourceEnabled: true
        dashboards:
          enabled: true
          defaultFolderName: "General"
          label: grafana_dashboard
          labelValue: "1"
      extraInitContainers:
        - name: download-dashboards
          image: curlimages/curl:8.5.0
          command:
            - /bin/sh
            - -c
            - |
              mkdir -p /var/lib/grafana/dashboards/default
              # Kubernetes Cluster Overview
              curl -sfL https://grafana.com/api/dashboards/15757/revisions/44/download -o /var/lib/grafana/dashboards/default/k8s-cluster.json
              # Node Exporter Full
              curl -sfL https://grafana.com/api/dashboards/1860/revisions/37/download -o /var/lib/grafana/dashboards/default/node-exporter.json
              # Traefik Dashboard
              curl -sfL https://grafana.com/api/dashboards/17346/revisions/9/download -o /var/lib/grafana/dashboards/default/traefik.json
              # Kubernetes Pods
              curl -sfL https://grafana.com/api/dashboards/15760/revisions/27/download -o /var/lib/grafana/dashboards/default/k8s-pods.json
              # Loki Logs
              curl -sfL https://grafana.com/api/dashboards/13639/revisions/2/download -o /var/lib/grafana/dashboards/default/loki-logs.json
          volumeMounts:
            - name: dashboards-default
              mountPath: /var/lib/grafana/dashboards/default
      dashboardProviders:
        dashboardproviders.yaml:
          apiVersion: 1
          providers:
            - name: 'default'
              orgId: 1
              folder: 'General'
              type: file
              disableDeletion: false
              editable: true
              options:
                path: /var/lib/grafana/dashboards/default
      additionalDataSources:
        - name: Loki
          type: loki
          uid: loki
          url: http://loki.logging.svc.cluster.local:3100
          access: proxy
          isDefault: false
          editable: true
          jsonData:
            maxLines: 1000
        - name: Tempo
          type: tempo
          uid: tempo
          url: http://tempo.monitoring.svc.cluster.local:3200
          access: proxy
          isDefault: false
          editable: true
          jsonData:
            httpMethod: GET
            tracesToLogs:
              datasourceUid: loki
              tags: ['job', 'instance', 'pod', 'namespace']
            tracesToMetrics:
              datasourceUid: prometheus
            serviceMap:
              datasourceUid: prometheus
            nodeGraph:
              enabled: true

    prometheus:
      prometheusSpec:
        serviceMonitorSelectorNilUsesHelmValues: false
        externalUrl: http://192.168.0.112:8080/prometheus/
        routePrefix: /

    alertmanager:
      enabled: true
      service:
        type: ClusterIP
      alertmanagerSpec:
        externalUrl: http://192.168.0.112:8080/alertmanager/
        routePrefix: /

    defaultRules:
      create: true

    nameOverride: kps
